<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Listas Suspensas - FAF</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
</head>
<body>
  <div class="container-fluid mt-4">
    <!-- Cabeçalho -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h2><i class="bi bi-list-ul"></i> Listas Suspensas</h2>
        <p class="text-muted">Gerenciamento de tabelas categóricas</p>
      </div>
      <a href="{{ url_for('main.tela_inicial') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Voltar
      </a>
    </div>

    <!-- Seleção de Tabela -->
    <div class="card mb-4">
      <div class="card-body">
        <label for="seletorTabela" class="form-label fw-bold">Selecione a tabela:</label>
        <select id="seletorTabela" class="form-select form-select-lg" onchange="carregarTabela()">
          <option value="">-- Escolha uma tabela --</option>
          {% for chave, config in tabelas.items() %}
          <option value="{{ chave }}">{{ config.nome }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <!-- Área de conteúdo da tabela -->
    <div id="areaConteudo" style="display: none;">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0" id="tituloTabela"></h5>
          <button class="btn btn-success" onclick="abrirModalCriar()">
            <i class="bi bi-plus-circle"></i> Adicionar
          </button>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover table-striped" id="tabelaDados">
              <thead class="table-dark">
                <tr id="cabecalhoTabela"></tr>
              </thead>
              <tbody id="corpoTabela"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para Criar/Editar -->
  <div class="modal fade" id="modalFormulario" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="tituloModal">Novo Registro</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="formularioRegistro">
            <div id="camposFormulario"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" onclick="salvarRegistro()">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let tabelaAtual = null;
    let configAtual = null;
    let registroEditando = null;
    let modalFormulario = null;

    document.addEventListener('DOMContentLoaded', function() {
      modalFormulario = new bootstrap.Modal(document.getElementById('modalFormulario'));
    });

    async function carregarTabela() {
      const select = document.getElementById('seletorTabela');
      tabelaAtual = select.value;
      
      if (!tabelaAtual) {
        document.getElementById('areaConteudo').style.display = 'none';
        return;
      }

      try {
        const response = await fetch(`/listas/api/dados/${tabelaAtual}`);
        const data = await response.json();
        
        if (data.erro) {
          alert('Erro: ' + data.erro);
          return;
        }

        configAtual = data.config;
        const dados = data.dados;

        // Atualizar título
        document.getElementById('tituloTabela').textContent = configAtual.nome;

        // Construir cabeçalho da tabela
        const cabecalho = document.getElementById('cabecalhoTabela');
        cabecalho.innerHTML = '';
        
        // Adicionar colunas
        for (const col of configAtual.colunas_editaveis) {
          const th = document.createElement('th');
          th.textContent = configAtual.labels[col];
          cabecalho.appendChild(th);
        }
        
        // Coluna de ações
        const thAcoes = document.createElement('th');
        thAcoes.textContent = 'Ações';
        thAcoes.style.width = '150px';
        cabecalho.appendChild(thAcoes);

        // Construir corpo da tabela
        const corpo = document.getElementById('corpoTabela');
        corpo.innerHTML = '';

        for (const registro of dados) {
          const tr = document.createElement('tr');
          
          // Adicionar dados
          for (const col of configAtual.colunas_editaveis) {
            const td = document.createElement('td');
            td.textContent = registro[col] || '-';
            tr.appendChild(td);
          }

          // Adicionar ações
          const tdAcoes = document.createElement('td');
          tdAcoes.innerHTML = `
            <button class="btn btn-sm btn-primary" onclick='editarRegistro(${JSON.stringify(registro)})'>
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-danger" onclick="excluirRegistro(${registro.id})">
              <i class="bi bi-trash"></i>
            </button>
          `;
          tr.appendChild(tdAcoes);

          corpo.appendChild(tr);
        }

        // Mostrar área de conteúdo
        document.getElementById('areaConteudo').style.display = 'block';

      } catch (error) {
        console.error('Erro ao carregar tabela:', error);
        alert('Erro ao carregar dados da tabela');
      }
    }

    function abrirModalCriar() {
      registroEditando = null;
      document.getElementById('tituloModal').textContent = `Novo Registro - ${configAtual.nome}`;
      
      // Construir formulário
      const camposDiv = document.getElementById('camposFormulario');
      camposDiv.innerHTML = '';

      for (const col of configAtual.colunas_editaveis) {
        const div = document.createElement('div');
        div.className = 'mb-3';
        
        const label = document.createElement('label');
        label.className = 'form-label';
        label.textContent = configAtual.labels[col];
        
        let input;
        if (col === 'descricao') {
          input = document.createElement('textarea');
          input.rows = 3;
        } else {
          input = document.createElement('input');
          input.type = 'text';
        }
        input.className = 'form-control';
        input.id = `campo_${col}`;
        input.required = true;
        
        div.appendChild(label);
        div.appendChild(input);
        camposDiv.appendChild(div);
      }

      modalFormulario.show();
    }

    function editarRegistro(registro) {
      registroEditando = registro;
      document.getElementById('tituloModal').textContent = `Editar Registro - ${configAtual.nome}`;
      
      // Construir formulário com valores
      const camposDiv = document.getElementById('camposFormulario');
      camposDiv.innerHTML = '';

      for (const col of configAtual.colunas_editaveis) {
        const div = document.createElement('div');
        div.className = 'mb-3';
        
        const label = document.createElement('label');
        label.className = 'form-label';
        label.textContent = configAtual.labels[col];
        
        let input;
        if (col === 'descricao') {
          input = document.createElement('textarea');
          input.rows = 3;
        } else {
          input = document.createElement('input');
          input.type = 'text';
        }
        input.className = 'form-control';
        input.id = `campo_${col}`;
        input.value = registro[col] || '';
        input.required = true;
        
        div.appendChild(label);
        div.appendChild(input);
        camposDiv.appendChild(div);
      }

      modalFormulario.show();
    }

    async function salvarRegistro() {
      // Coletar dados do formulário
      const dados = {};
      for (const col of configAtual.colunas_editaveis) {
        const input = document.getElementById(`campo_${col}`);
        if (!input.value.trim()) {
          alert(`O campo ${configAtual.labels[col]} é obrigatório`);
          return;
        }
        dados[col] = input.value.trim();
      }

      try {
        let url, method;
        
        if (registroEditando) {
          // Editar
          url = `/listas/api/dados/${tabelaAtual}/${registroEditando.id}`;
          method = 'PUT';
        } else {
          // Criar
          url = `/listas/api/dados/${tabelaAtual}`;
          method = 'POST';
        }

        const response = await fetch(url, {
          method: method,
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(dados)
        });

        const result = await response.json();

        if (result.erro) {
          alert('Erro: ' + result.erro);
          return;
        }

        // Fechar modal e recarregar tabela
        modalFormulario.hide();
        carregarTabela();
        
        alert(result.mensagem);

      } catch (error) {
        console.error('Erro ao salvar:', error);
        alert('Erro ao salvar registro');
      }
    }

    async function excluirRegistro(id) {
      if (!confirm('Tem certeza que deseja excluir este registro?')) {
        return;
      }

      try {
        const response = await fetch(`/listas/api/dados/${tabelaAtual}/${id}`, {
          method: 'DELETE'
        });

        const result = await response.json();

        if (result.erro) {
          alert('Erro: ' + result.erro);
          return;
        }

        carregarTabela();
        alert(result.mensagem);

      } catch (error) {
        console.error('Erro ao excluir:', error);
        alert('Erro ao excluir registro');
      }
    }
  </script>
</body>
</html>
