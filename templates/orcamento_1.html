<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orçamento Anual - FAF</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .table-responsive {
            margin-top: 1rem;
        }
        .btn-action {
            font-size: 0.875rem;
            padding: 0.25rem 0.5rem;
        }
        .status-card {
            text-align: center;
            padding: 1rem;
        }
        .filter-section {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
        }
        .sortable {
            cursor: pointer;
            user-select: none;
        }
        .sortable:hover {
            background-color: #e9ecef;
        }
        .sort-icon {
            margin-left: 0.5rem;
            opacity: 0.5;
        }
        .sort-active {
            opacity: 1;
        }
        .text-center {
            text-align: center !important;
        }
        .sei-formatted {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        .status-card {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .status-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .status-card.active {
            box-shadow: 0 0 15px rgba(0,123,255,0.5);
            border-width: 2px !important;
        }
        .filter-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #007bff;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        .filter-indicator.filter-active {
            display: flex;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1>Orçamento Anual</h1>
                    <div class="d-flex gap-2">
                        <button class="btn btn-success" onclick="exportarCSV()">
                            <i class="bi bi-file-earmark-spreadsheet"></i> Exportar CSV
                        </button>
                        <a href="{{ url_for('orcamento.dicionario_despesas') }}" class="btn btn-info">
                            <i class="bi bi-book"></i> Ver Dicionário de Despesas
                        </a>
                        <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Voltar
                        </a>
                    </div>
                </div>

                <!-- Estatísticas -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card border-success status-card {% if filtro_status == 'correto' %}active{% endif %}" id="cardFeitoCorreto" onclick="filtrarPorStatus('correto')" style="position: relative;">
                            <div class="card-body">
                                <h5 class="card-title text-success">Feito Corretamente</h5>
                                <h3 class="text-success">{{ estatisticas.feito_corretamente.quantidade }}</h3>
                                <p class="card-text">{{ "%.2f"|format(estatisticas.feito_corretamente.percentual) }}%</p>
                                <div class="filter-indicator {% if filtro_status == 'correto' %}filter-active{% endif %}" id="indicadorCorreto">✓</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-warning status-card {% if filtro_status == 'nao_feito' %}active{% endif %}" id="cardNaoFeito" onclick="filtrarPorStatus('nao_feito')" style="position: relative;">
                            <div class="card-body">
                                <h5 class="card-title text-warning">Não Feito</h5>
                                <h3 class="text-warning">{{ estatisticas.nao_feito.quantidade }}</h3>
                                <p class="card-text">{{ "%.2f"|format(estatisticas.nao_feito.percentual) }}%</p>
                                <div class="filter-indicator {% if filtro_status == 'nao_feito' %}filter-active{% endif %}" id="indicadorNaoFeito">✓</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-danger status-card {% if filtro_status == 'incorreto' %}active{% endif %}" id="cardFeitoIncorreto" onclick="filtrarPorStatus('incorreto')" style="position: relative;">
                            <div class="card-body">
                                <h5 class="card-title text-danger">Feito Incorretamente</h5>
                                <h3 class="text-danger">{{ estatisticas.feito_incorretamente.quantidade }}</h3>
                                <p class="card-text">{{ "%.2f"|format(estatisticas.feito_incorretamente.percentual) }}%</p>
                                <div class="filter-indicator {% if filtro_status == 'incorreto' %}filter-active{% endif %}" id="indicadorIncorreto">✓</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Indicador de filtro ativo -->
                {% if filtro_status %}
                <div class="alert alert-info alert-dismissible fade show d-flex align-items-center" role="alert">
                    <i class="bi bi-funnel-fill me-2"></i>
                    <strong>Filtro ativo:</strong>&nbsp;
                    {% if filtro_status == 'correto' %}
                        Mostrando apenas termos <strong>Feitos Corretamente</strong>
                    {% elif filtro_status == 'nao_feito' %}
                        Mostrando apenas termos <strong>Não Feitos</strong>
                    {% elif filtro_status == 'incorreto' %}
                        Mostrando apenas termos <strong>Feitos Incorretamente</strong>
                    {% endif %}
                    <a href="{{ url_for('orcamento.listar', limite=limite, filtro_termo=filtro_termo) }}" class="btn btn-sm btn-outline-secondary ms-auto">
                        <i class="bi bi-x"></i> Remover filtro
                    </a>
                </div>
                {% endif %}

                <!-- Filtros -->
                <div class="filter-section">
                    <form method="get" action="{{ url_for('orcamento.listar') }}">
                        <div class="row">
                            <div class="col-md-4">
                                <label for="filtro_termo" class="form-label">Filtrar por Número do Termo</label>
                                <input type="text" class="form-control" id="filtro_termo" name="filtro_termo" 
                                       value="{{ filtro_termo or '' }}" placeholder="Digite o número do termo...">
                            </div>
                            <div class="col-md-3">
                                <label for="limite" class="form-label">Mostrar somente</label>
                                <select class="form-select" id="limite" name="limite">
                                  <option value="10" {% if limite == '10' %}selected{% endif %}>10 linhas</option>
                                  <option value="50" {% if limite == '50' %}selected{% endif %}>50 linhas</option>
                                  <option value="100" {% if limite == '100' %}selected{% endif %}>100 linhas</option>
                                  <option value="1000" {% if limite == '1000' %}selected{% endif %}>1000 linhas</option>
                                  <option value="todas" {% if limite == 'todas' %}selected{% endif %}>Todas</option>
                                </select>
                            </div>
                            <div class="col-md-5 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary me-2">
                                    <i class="bi bi-search"></i> Aplicar Filtros
                                </button>
                                <a href="{{ url_for('orcamento.listar') }}" class="btn btn-secondary me-2">
                                    <i class="bi bi-x-circle"></i> Limpar Filtros
                                </a>
                                <button type="button" class="btn btn-success" onclick="exportarDados()">
                                    <i class="bi bi-download"></i> Exportar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Tabela Principal -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="tabelaOrcamento">
                        <thead class="table-dark">
                            <tr>
                                <th class="sortable text-center" onclick="ordenarTabela(0)">
                                    Número do Termo
                                    <i class="bi bi-arrow-down-up sort-icon"></i>
                                </th>
                                <th class="sortable" onclick="ordenarTabela(1)">
                                    Tipo de Contrato
                                    <i class="bi bi-arrow-down-up sort-icon"></i>
                                </th>
                                <th class="sortable" onclick="ordenarTabela(2)">
                                    SEI Celebração
                                    <i class="bi bi-arrow-down-up sort-icon"></i>
                                </th>
                                <th class="sortable" onclick="ordenarTabela(3)">
                                    Total Previsto
                                    <i class="bi bi-arrow-down-up sort-icon"></i>
                                </th>
                                <th class="sortable" onclick="ordenarTabela(4)">
                                    Total Preenchido
                                    <i class="bi bi-arrow-down-up sort-icon"></i>
                                </th>
                                <th class="sortable" onclick="ordenarTabela(5)">
                                    Meses
                                    <i class="bi bi-arrow-down-up sort-icon"></i>
                                </th>
                                <th>Ação</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaBody">
                            {% for parceria in parcerias %}
                            <tr class="linha-parceria" data-termo="{{ parceria.numero_termo }}">
                                <td class="text-center">{{ parceria.numero_termo }}</td>
                                <td>{{ parceria.tipo_termo or '-' }}</td>
                                <td class="sei-formatted">{{ parceria.sei_celeb or '-' }}</td>
                                <td class="text-end">R$ {{ parceria.total_previsto|format_brl }}</td>
                                <td class="text-end">R$ {{ parceria.total_preenchido|format_brl }}</td>
                                <td class="text-center">{{ parceria.meses if parceria.meses is not none else '-' }}</td>
                                <td>
                                    {% if parceria.total_preenchido == 0 %}
                                        <a class="btn btn-success btn-action" href="{{ url_for('orcamento.editar', numero_termo=parceria.numero_termo) }}">
                                            <i class="bi bi-plus-circle"></i> Preencher
                                        </a>
                                    {% else %}
                                        <a class="btn btn-warning btn-action" href="{{ url_for('orcamento.editar', numero_termo=parceria.numero_termo) }}">
                                            <i class="bi bi-pencil"></i> Modificar
                                        </a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                {% if not parcerias %}
                <div class="alert alert-info text-center" role="alert">
                    <i class="bi bi-info-circle"></i> Nenhuma parceria encontrada.
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Modal para Preenchimento/Modificação de Orçamento -->
    <div class="modal fade" id="modalOrcamento" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Preencher Orçamento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <strong>Termo:</strong> <span id="termoAtual"></span><br>
                        <strong>Total Previsto:</strong> R$ <span id="totalPrevisto">0,00</span>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered" id="tabelaOrcamentoModal">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 120px">Rubrica</th>
                                    <th style="width: 80px">Qtd</th>
                                    <th style="width: 200px">Categoria de Despesa</th>
                                    <th>Ação</th>
                                    <!-- Colunas de meses serão inseridas dinamicamente -->
                                </tr>
                            </thead>
                            <tbody id="linhasOrcamento">
                                <!-- Linhas serão inseridas dinamicamente -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-3">
                        <button type="button" class="btn btn-success btn-sm" onclick="adicionarLinha()">
                            <i class="bi bi-plus"></i> Adicionar Linha
                        </button>
                        <div class="float-end">
                            <strong>Total Calculado: R$ <span id="totalCalculado">0,00</span></strong>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarOrcamentoCompleto()">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let ordemAtual = { coluna: -1, ascendente: true };
        let termoAtual = null;
        let numeroMeses = 0;
        let contadorLinhas = 0;
        let filtroStatusAtivo = null; // Controla qual filtro de status está ativo

        // Detectar tolerância para igualdade de valores
        function valoresIguais(val1, val2, tolerancia = 0.01) {
            return Math.abs(val1 - val2) <= tolerancia;
        }

        // Função para filtrar por status
        function filtrarPorStatus(tipo) {
            // Construir URL com parâmetros (filtro via backend)
            const urlParams = new URLSearchParams(window.location.search);
            
            // Se o mesmo filtro for clicado novamente, remove o filtro
            const filtroAtual = urlParams.get('status');
            if (filtroAtual === tipo) {
                urlParams.delete('status');
            } else {
                urlParams.set('status', tipo);
            }
            
            // Redirecionar para a mesma página com o novo filtro
            window.location.href = '{{ url_for("orcamento.listar") }}?' + urlParams.toString();
        }

        // Ordenação da tabela
        function ordenarTabela(coluna) {
            const tabela = document.getElementById('tabelaOrcamento');
            const tbody = document.getElementById('tabelaBody');
            const linhas = Array.from(tbody.querySelectorAll('tr'));
            
            if (ordemAtual.coluna === coluna) {
                ordemAtual.ascendente = !ordemAtual.ascendente;
            } else {
                ordemAtual.ascendente = true;
            }
            ordemAtual.coluna = coluna;

            document.querySelectorAll('.sort-icon').forEach(icon => {
                icon.className = 'bi bi-arrow-down-up sort-icon';
            });
            
            const iconAtual = tabela.querySelectorAll('.sort-icon')[coluna];
            iconAtual.className = `bi bi-arrow-${ordemAtual.ascendente ? 'up' : 'down'} sort-icon sort-active`;

            linhas.sort((a, b) => {
                let valorA = a.cells[coluna].textContent.trim();
                let valorB = b.cells[coluna].textContent.trim();

                if (coluna === 3 || coluna === 4) {
                    valorA = parseFloat(valorA.replace('R$ ', '').replace('.', '').replace(',', '.')) || 0;
                    valorB = parseFloat(valorB.replace('R$ ', '').replace('.', '').replace(',', '.')) || 0;
                }

                if (valorA < valorB) return ordemAtual.ascendente ? -1 : 1;
                if (valorA > valorB) return ordemAtual.ascendente ? 1 : -1;
                return 0;
            });

            linhas.forEach(linha => tbody.appendChild(linha));
        }

        // Limpar filtros
        function limparFiltros() {
            // Limpar filtro por termo
            document.getElementById('filtroTermo').value = '';
            
            // Limpar filtro de status
            filtroStatusAtivo = null;
            document.querySelectorAll('.status-card').forEach(card => card.classList.remove('active'));
            document.querySelectorAll('.filter-indicator').forEach(ind => ind.style.display = 'none');
            
            // Mostrar todas as linhas
            document.querySelectorAll('.linha-parceria').forEach(linha => {
                linha.style.display = '';
            });
        }

        // Atualizar limite de linhas
        function atualizarLimite() {
            const limite = document.getElementById('limite').value;
            const url = new URL(window.location);
            url.searchParams.set('limite', limite);
            window.location = url.toString();
        }

        // Abrir modal para preencher/modificar
        function preencherOrcamento(numeroTermo) {
            termoAtual = numeroTermo;
            document.getElementById('modalTitle').textContent = 'Preencher Orçamento';
            document.getElementById('termoAtual').textContent = numeroTermo;
            
            // Buscar informações do termo
            fetch(`/api/termo/${numeroTermo}`)
                .then(response => {
                    console.log('Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Dados recebidos:', data);
                    if (data.error) {
                        alert('Erro: ' + data.error);
                        return;
                    }
                    
                    numeroMeses = data.meses;
                    document.getElementById('totalPrevisto').textContent = (data.total_previsto || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2});
                    
                    criarCabecalhoTabela();
                    limparTabela();
                    adicionarLinha();
                    
                    new bootstrap.Modal(document.getElementById('modalOrcamento')).show();
                })
                .catch(error => {
                    console.error('Erro detalhado:', error);
                    alert('Erro ao carregar informações do termo: ' + error.message);
                });
        }

        function modificarOrcamento(numeroTermo) {
            preencherOrcamento(numeroTermo); // Por enquanto usa a mesma lógica
        }

        // Criar cabeçalho da tabela com colunas de meses
        function criarCabecalhoTabela() {
            const thead = document.querySelector('#tabelaOrcamentoModal thead tr');
            // Remove colunas de meses existentes
            const existingHeaders = thead.querySelectorAll('.mes-header');
            existingHeaders.forEach(h => h.remove());
            
            // Adiciona novas colunas de meses
            for (let i = 1; i <= numeroMeses; i++) {
                const th = document.createElement('th');
                th.className = 'mes-header';
                th.style.width = '100px';
                th.textContent = `Mês ${i}`;
                thead.appendChild(th);
            }
        }

        // Limpar tabela
        function limparTabela() {
            document.getElementById('linhasOrcamento').innerHTML = '';
            contadorLinhas = 0;
            atualizarTotal();
        }

        // Adicionar nova linha
        function adicionarLinha() {
            contadorLinhas++;
            const tbody = document.getElementById('linhasOrcamento');
            const tr = document.createElement('tr');
            tr.id = `linha${contadorLinhas}`;
            
            // Rubrica
            const tdRubrica = document.createElement('td');
            const selectRubrica = document.createElement('select');
            selectRubrica.className = 'form-select form-select-sm';
            selectRubrica.name = 'rubrica';
            selectRubrica.onchange = function() { onRubricaChange(this, contadorLinhas); };
            selectRubrica.innerHTML = `
                <option value="">Selecione...</option>
                <option value="Pessoal">Pessoal</option>
                <option value="Materiais">Materiais</option>
                <option value="Administrativas">Administrativas</option>
                <option value="Serviços de Terceiros">Serviços de Terceiros</option>
                <option value="Outras Despesas">Outras Despesas</option>
                <option value="Imobilizado">Imobilizado</option>
                <option value="Implantação">Implantação</option>
            `;
            tdRubrica.appendChild(selectRubrica);
            tr.appendChild(tdRubrica);
            
            // Quantidade
            const tdQuantidade = document.createElement('td');
            const inputQuantidade = document.createElement('input');
            inputQuantidade.type = 'text';
            inputQuantidade.className = 'form-control form-control-sm';
            inputQuantidade.name = 'quantidade';
            inputQuantidade.value = '1';
            inputQuantidade.id = `quantidade${contadorLinhas}`;
            // permitir apenas dígitos ou '-' e limitar tamanho
            inputQuantidade.oninput = function() {
                // remover tudo que não seja dígito ou '-'
                this.value = this.value.replace(/[^0-9\-]/g, '');
                // permitir apenas '-' isolado
                if (this.value.indexOf('-') !== -1) {
                    this.value = '-';
                }
                // evitar zeros à esquerda
                if (this.value.length > 1 && this.value !== '-') {
                    this.value = String(parseInt(this.value, 10));
                }
            };
            tdQuantidade.appendChild(inputQuantidade);
            tr.appendChild(tdQuantidade);
            
            // Categoria
            const tdCategoria = document.createElement('td');
            const inputCategoria = document.createElement('input');
            inputCategoria.type = 'text';
            inputCategoria.className = 'form-control form-control-sm';
            inputCategoria.name = 'categoria_despesa';
            inputCategoria.placeholder = 'Ex: Gerente de Serviço I';
            tdCategoria.appendChild(inputCategoria);
            tr.appendChild(tdCategoria);
            
            // Ação
            const tdAcao = document.createElement('td');
            const btnRemover = document.createElement('button');
            btnRemover.type = 'button';
            btnRemover.className = 'btn btn-danger btn-sm';
            btnRemover.innerHTML = '<i class="bi bi-trash"></i>';
            btnRemover.onclick = function() { removerLinha(contadorLinhas); };
            tdAcao.appendChild(btnRemover);
            tr.appendChild(tdAcao);
            
            // Colunas de meses
            for (let i = 1; i <= numeroMeses; i++) {
                const tdMes = document.createElement('td');
                const inputMes = document.createElement('input');
                inputMes.type = 'text';
                inputMes.className = 'form-control form-control-sm valor-input';
                inputMes.name = `mes${i}`;
                inputMes.placeholder = '0,00';
                inputMes.onkeyup = function() { formatarMoeda(this); atualizarTotal(); };
                tdMes.appendChild(inputMes);
                tr.appendChild(tdMes);
            }
            
            tbody.appendChild(tr);
        }

        // Evento quando rubrica muda
        function onRubricaChange(select, linhaId) {
            const quantidade = document.getElementById(`quantidade${linhaId}`);
            if (select.value === 'Administrativas' || select.value === 'Implantação') {
                quantidade.value = '-';
            } else if (quantidade.value === '-') {
                quantidade.value = '1';
            }
        }

        // Remover linha
        function removerLinha(linhaId) {
            const linha = document.getElementById(`linha${linhaId}`);
            if (linha) {
                linha.remove();
                atualizarTotal();
            }
        }

        // Formatação de moeda
        function formatarMoeda(input) {
            let valor = input.value.replace(/\D/g, '');
            if (valor === '') {
                input.value = '';
                return;
            }
            valor = (valor / 100).toFixed(2) + '';
            valor = valor.replace(".", ",");
            valor = valor.replace(/(\d)(\d{3})(\d{3}),/g, "$1.$2.$3,");
            valor = valor.replace(/(\d)(\d{3}),/g, "$1.$2,");
            input.value = valor;
        }

        // Atualizar total calculado
        function atualizarTotal() {
            let total = 0;
            const inputs = document.querySelectorAll('.valor-input');
            inputs.forEach(input => {
                if (input.value && input.value !== '') {
                    const valor = parseFloat(input.value.replace(/\./g, '').replace(',', '.')) || 0;
                    total += valor;
                }
            });
            document.getElementById('totalCalculado').textContent = total.toLocaleString('pt-BR', {minimumFractionDigits: 2});
        }

        // Salvar orçamento completo
        function salvarOrcamentoCompleto() {
            const linhas = document.querySelectorAll('#linhasOrcamento tr');
            const despesas = [];
            
            linhas.forEach(linha => {
                const rubrica = linha.querySelector('select[name="rubrica"]').value;
                const quantidade = linha.querySelector('input[name="quantidade"]').value;
                const categoria = linha.querySelector('input[name="categoria_despesa"]').value;
                
                if (!rubrica) return;
                // validar quantidade: '-' ou inteiro >= 0
                if (!(quantidade === '-' || (/^\d+$/.test(quantidade) && parseInt(quantidade,10) >= 0))) {
                    alert(`Quantidade inválida na linha: ${quantidade}. Use inteiro ou '-'`);
                    throw new Error('Quantidade inválida');
                }
                
                const valores_por_mes = {};
                for (let i = 1; i <= numeroMeses; i++) {
                    const input = linha.querySelector(`input[name="mes${i}"]`);
                    if (input && input.value) {
                        valores_por_mes[i] = input.value;
                    }
                }
                
                if (Object.keys(valores_por_mes).length > 0) {
                    despesas.push({
                        rubrica: rubrica,
                        quantidade: quantidade,
                        categoria_despesa: categoria,
                        valores_por_mes: valores_por_mes
                    });
                }
            });
            
            if (despesas.length === 0) {
                alert('Preencha pelo menos uma despesa');
                return;
            }
            
            const dados = {
                numero_termo: termoAtual,
                despesas: despesas
            };
            
            fetch('/api/despesa', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dados)
            })
            .then(response => response.json())
            .then(data => {
                if (data.warning) {
                    if (confirm(data.message + '\n\nDeseja prosseguir mesmo assim?')) {
                        // Confirmar inserção
                        fetch('/api/despesa/confirmar', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(dados)
                        })
                        .then(response => response.json())
                        .then(result => {
                            if (result.message) {
                                alert(result.message);
                                bootstrap.Modal.getInstance(document.getElementById('modalOrcamento')).hide();
                                location.reload();
                            } else {
                                alert('Erro: ' + (result.error || 'Erro desconhecido'));
                            }
                        });
                    }
                } else if (data.message) {
                    alert(data.message);
                    bootstrap.Modal.getInstance(document.getElementById('modalOrcamento')).hide();
                    location.reload();
                } else {
                    alert('Erro: ' + (data.error || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao salvar orçamento');
            });
        }

        // Exportar dados (placeholder)
        function exportarDados() {
            alert('Funcionalidade de exportação será implementada em breve');
        }

        // Exportar para CSV
        function exportarCSV() {
            // Mostrar indicador de carregamento
            const btnExportar = event.target.closest('button');
            const textoOriginal = btnExportar.innerHTML;
            btnExportar.disabled = true;
            btnExportar.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Exportando...';
            
            // Fazer requisição para a API de exportação
            window.location.href = '{{ url_for("orcamento.exportar_csv") }}';
            
            // Restaurar botão após um tempo
            setTimeout(() => {
                btnExportar.disabled = false;
                btnExportar.innerHTML = textoOriginal;
            }, 2000);
        }
    </script>
</body>
</html>
